* QMK keyboard configs
Personal QMK configuration for [[https://github.com/foostan/crkbd][corne]] and [[https://github.com/kata0510/Lily58][lily58]] keyboards.

Structure inspired by:
- [[https://github.com/manna-harbour/miryoku_babel][Miryoky Babel]]
- [[https://github.com/Kranex/qmk-config][Kranex qmk config]]

Build:
1. run ~./flash.sh build~.
  
Usage:
1. define the keymap in tables;
2. run ~org-babel-execute-buffer~;
3. run ~org-babel-tangle~;
4. (optional) execute the python code cell to generate the the keymap image;
5. run ~./flash.sh flash lily~ or ~./flash.sh flash corne~ (add dialout group to the user before this step).

** Lily58
[[file:./lily58/layers/base.png]]
[[file:./lily58/layers/num.png]]
[[file:./lily58/layers/navigation.png]]

*** Base
#+NAME: base-layer-left
| KC_ESC         | KC_1 | KC_2 | KC_3 | KC_4 | KC_5 |
| LGUI(KC_TAB)   | KC_Q | KC_W | KC_F | KC_P | KC_B |
| LCTL_T(KC_ESC) | KC_A | KC_R | KC_S | KC_T | KC_G |
| KC_CAPS        | KC_Z | KC_X | KC_C | KC_D | KC_V |

#+NAME:  base-layer-right
| KC_6 | KC_7 | KC_8     | KC_9   | KC_0    | KC_ESC       |
| KC_J | KC_L | KC_U     | KC_Y   | KC_QUOT | LCTL(KC_T)   |
| KC_M | KC_N | KC_E     | KC_I   | KC_O    | KC_SCLN      |
| KC_K | KC_H | KC_COMMA | KC_DOT | KC_SLSH | LCTL(KC_TAB) |

#+NAME: base-layer-left-thumb
| KC_NO | LT(_NAV, KC_ESC) | LGUI_T(KC_SPC) | SFT_T(KC_TAB) | KC_NO |

#+NAME: base-layer-right-thumb
| KC_NO | LCTL_T(KC_ENT) | LT(_NUM, KC_BSPC) | KC_LALT | KC_NO |

*** Navigation
#+NAME: navigation-layer-left
| KC_NO | KC_NO | KC_NO | KC_NO | KC_NO | KC_NO |
| KC_NO | KC_NO | KC_NO | KC_NO | KC_NO | KC_NO |
| KC_NO | KC_NO | KC_NO | KC_NO | KC_NO | KC_NO |
| KC_NO | KC_NO | KC_NO | KC_NO | KC_NO | KC_NO |

#+NAME: navigation-layer-right
| KC_NO   | KC_NO   | KC_NO   | KC_NO   | KC_NO | KC_NO |
| KC_MPRV | KC_VOLD | KC_VOLU | KC_MNXT | KC_NO | KC_NO |
| KC_LEFT | KC_DOWN | KC_UP   | KC_RGHT | KC_NO | KC_NO |
| KC_HOME | KC_END  | KC_MPLY | KC_MUTE | KC_NO | KC_NO |

#+NAME: navigation-layer-left-thumb
| KC_NO | KC_NO | KC_TRNS | KC_NO | KC_NO |

#+NAME: navigation-layer-right-thumb
| KC_NO | KC_ENT | KC_BSPC | KC_NO | KC_NO |

*** Num
#+NAME: num-layer-left
| KC_NO | KC_NO   | KC_NO | KC_NO | KC_NO | KC_NO   |
| RESET | KC_LBRC | KC_7  | KC_8  | KC_9  | KC_RBRC |
| KC_NO | KC_0    | KC_4  | KC_5  | KC_6  | KC_EQL  |
| KC_NO | KC_GRV  | KC_1  | KC_2  | KC_3  | KC_BSLS |

#+NAME: num-layer-right
| KC_NO   | KC_NO   | KC_NO   | KC_NO   | KC_NO   | KC_NO |
| KC_LCBR | KC_LPRN | KC_ASTR | KC_AMPR | KC_RCBR | KC_NO |
| KC_PLUS | KC_CIRC | KC_PERC | KC_DLR  | KC_RPRN | KC_NO |
| KC_PIPE | KC_HASH | KC_AT   | KC_EXLM | KC_TILD | KC_NO |

#+NAME: num-layer-left-thumb
| KC_NO | KC_UNDS | KC_SPC | KC_MINS | KC_NO |

#+NAME: num-layer-right-thumb
| KC_NO | KC_ENT | KC_TRNS | KC_NO | KC_NO |

*** Visualization
#+name: image-manipulation
#+begin_src python :var layer_name="Base" :var img_path="./lily58/layers/base.png" :var in_layer_left=base-layer-left :var in_layer_right=base-layer-right :var in_layer_right_thumb=base-layer-right-thumb :var in_layer_left_thumb=base-layer-left-thumb :results none silent
  from PIL import Image, ImageDraw, ImageFont


  mapper = {
      "QUOT": "'",
      "COMMA": ",",
      "DOT": ".",
      "SLSH": "/",
      "SCLN": ";",
  }


  def format_key(key):
      key = key.replace("KC_", "")
      key = mapper.get(key, key)
      if key.startswith("LCTL("):
          key = key.replace("LCTL(", "C+\n")
          key = key.replace(")", "")
      if key.startswith("LGUI("):
          key = key.replace("LGUI(", "G+\n")
          key = key.replace(")", "")
      if key.startswith("LCTL_T"):
          key = key.replace("LCTL_T(", "C/\n")
          key = key.replace(")", "")
      if key.startswith("SFT_T"):
          key = key.replace("SFT_T(", "S/\n")
          key = key.replace(")", "")
      if key.startswith("LGUI_T"):
          key = key.replace("LGUI_T(", "G/\n")
          key = key.replace(")", "")
      if key.startswith("LT"):
          key = key.replace("LT(", "")
          key = key.replace(")", "")
          key = key.replace(", ", "/\n")
      if key.startswith("NO"):
          key = key.replace("NO", "")
      return key


  def draw_left_keyboard(draw, layer):
      row_x = [20, 80, 137, 190, 243, 294]
      row_y = [
          [45, 38, 27, 22, 27, 38],
          [100, 93, 82, 77, 82, 93],
          [155, 148, 137, 132, 137, 148],
          [210, 203, 192, 187, 192, 203],
      ]
      for ir, col in enumerate(layer):
          ys = row_y[ir]
          for ik, (key, y) in enumerate(zip(col, ys)):
              x = row_x[ik]
              draw.text((x, y), format_key(key), fill=(0, 0, 0), font=font)


  def draw_left_thumb_keyboard(draw, layer):
      row_x = [155, 206, 263, 340, 342]
      row_y = [240, 240, 245, 255, 168]
      for ik, key in enumerate(layer):
          x = row_x[ik]
          y = row_y[ik]
          draw.text((x, y), format_key(key), fill=(0, 0, 0), font=font)


  def draw_right_keyboard(draw, layer):
      row_x = [510, 564, 618, 668, 723, 774]
      row_y = [
          [38, 27, 22, 27, 38, 45],
          [93, 82, 77, 82, 93, 100],
          [148, 137, 132, 137, 148, 155],
          [203, 192, 187, 192, 203, 210],
      ]
      for ir, col in enumerate(layer):
          ys = row_y[ir]
          for ik, (key, y) in enumerate(zip(col, ys)):
              x = row_x[ik]
              draw.text((x, y), format_key(key), fill=(0, 0, 0), font=font)


  def draw_right_thumb_keyboard(draw, layer):
      row_x = [450, 467, 530, 585, 638]
      row_y = [168, 255, 245, 240, 240]
      for ik, key in enumerate(layer):
          x = row_x[ik]
          y = row_y[ik]
          draw.text((x, y), format_key(key), fill=(0, 0, 0), font=font)


  img = Image.open("./assets/lily58.png")
  draw = ImageDraw.Draw(img)
  font = ImageFont.truetype("./assets/FreeMono.ttf", size=14)

  draw_left_keyboard(draw, in_layer_left)
  draw_left_thumb_keyboard(draw, in_layer_left_thumb[0])
  draw_right_keyboard(draw, in_layer_right)
  draw_right_thumb_keyboard(draw, in_layer_right_thumb[0])

  font = ImageFont.truetype("./assets/FreeMono.ttf", size=28)
  if layer_name == "Num" or layer_name == "Nav":
      draw.text((386, 80), layer_name, fill=(236, 239, 244), font=font)
  elif layer_name == "Base":
      draw.text((381, 80), layer_name, fill=(236, 239, 244), font=font)
  img.save(img_path)
#+end_src

#+begin_src python :noweb yes :results none silent
  <<image-manipulation(layer_name="Base", img_path="./lily58/layers/base.png", in_layer_left=base-layer-left, in_layer_right=base-layer-right, in_layer_right_thumb=base-layer-right-thumb, in_layer_left_thumb=base-layer-left-thumb)>>
  <<image-manipulation(layer_name="Num", img_path="./lily58/layers/num.png", in_layer_left=num-layer-left, in_layer_right=num-layer-right, in_layer_right_thumb=num-layer-right-thumb, in_layer_left_thumb=num-layer-left-thumb)>>
  <<image-manipulation(layer_name="Nav", img_path="./lily58/layers/navigation.png", in_layer_left=navigation-layer-left, in_layer_right=navigation-layer-right, in_layer_right_thumb=navigation-layer-right-thumb, in_layer_left_thumb=navigation-layer-left-thumb)>>
#+end_src

*** File generation
**** Keymap
#+name: layer-generator
#+begin_src python :session :var in_layer_left="None" :var in_layer_right="None" :var in_layer_left_thumb="None" :var in_layer_right_thumb="None" :results verbatim silent
  left_padding = 13


  def format_key(key, comma=True):
      if comma:
          return f"{key}, ".ljust(left_padding)
      else:
          return f"{key}".ljust(left_padding)


  def generate_left_keyboard(layer, layer_thumb):
      result = ""
      for i, row in enumerate(layer):
          for key in row:
              result += format_key(key)
          if i != len(layer) - 1:
              result += "\n"

      result += format_key(layer_thumb[0][-1])
      result += "\n"
      result += " " * 3 * left_padding
      for key in layer_thumb[0][:-1]:
          result += format_key(key)
      return result


  def generate_right_keyboard(layer, layer_thumb):
      result = ""
      for i, row in enumerate(layer):
          if i == 3:
              result += format_key(layer_thumb[0][0])
          else:
              result += " " * left_padding
          for key in row:
              result += format_key(key)
          if i != len(layer) - 1:
              result += "\n"

      result += "\n"
      for i, key in enumerate(layer_thumb[0][1:]):
          if i == len(layer_thumb[0][1:]) - 1:
            result += format_key(key, comma=False)
          else:
            result += format_key(key)
      return result


  def generate_keyboard(layer_left, layer_left_thumb, layer_right, layer_right_thumb):
      right = generate_left_keyboard(layer_left, layer_left_thumb).split("\n")
      left = generate_right_keyboard(layer_right, layer_right_thumb).split("\n")
      keyboard = ""
      for i, (r, l) in enumerate(zip(right, left)):
          if i < 3:
              keyboard += f'{r} {" " * left_padding} {l}\n'
          else:
              keyboard += f"{r}  {l}\n"
      return keyboard


  generate_keyboard(
      in_layer_left, in_layer_left_thumb, in_layer_right, in_layer_right_thumb
  )
#+end_src

#+begin_src C :main no :noweb yes :mkdirp yes :tangle ./lily58/keymap.c :mkdirp yes :results none silent
  #include QMK_KEYBOARD_H

  enum layer_number {
    _BASE,
    _NUM,
    _NAV,
  };
  const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
    [_BASE] = LAYOUT(
      <<layer-generator(in_layer_left=base-layer-left, in_layer_left_thumb=base-layer-left-thumb, in_layer_right=base-layer-right, in_layer_right_thumb=base-layer-right-thumb)>>
    ),
    [_NUM] = LAYOUT(
      <<layer-generator(in_layer_left=num-layer-left, in_layer_left_thumb=num-layer-left-thumb, in_layer_right=num-layer-right, in_layer_right_thumb=num-layer-right-thumb)>>
    ),
    [_NAV] = LAYOUT(
      <<layer-generator(in_layer_left=navigation-layer-left, in_layer_left_thumb=navigation-layer-left-thumb, in_layer_right=navigation-layer-right, in_layer_right_thumb=navigation-layer-right-thumb)>>
    )
  };
#+end_src

**** Config
#+begin_src C :main no :noweb yes :mkdirp yes :tangle ./lily58/config.h :mkdirp yes :results none silent
  #pragma once
  #define MASTER_RIGHT

  #define TAPPING_TERM 175
  #define AUTO_SHIFT_TIMEOUT 175
  #define AUTO_SHIFT_REPEAT
  #define NO_AUTO_SHIFT_SPECIAL
  #define NO_AUTO_SHIFT_NUMERIC

  #define IGNORE_MOD_TAP_INTERRUPT
#+end_src

**** Rules
#+begin_src C :main no :noweb yes :mkdirp yes :tangle ./lily58/rules.mk :mkdirp yes :results none silent
  BOOTMAGIC_ENABLE = no      # Enable Bootmagic Lite
  MOUSEKEY_ENABLE = no       # Mouse keys
  EXTRAKEY_ENABLE =  yes     # Audio control and System control
  CONSOLE_ENABLE = no        # Console for debug
  COMMAND_ENABLE = no        # Commands for debug and configuration
  NKRO_ENABLE = no
  BACKLIGHT_ENABLE = no      # Enable keyboard backlight functionality
  AUDIO_ENABLE = no          # Audio output
  RGBLIGHT_ENABLE = no       # Enable WS2812 RGB underlight.
  SWAP_HANDS_ENABLE = no     # Enable one-hand typing
  OLED_ENABLE= no            # OLED display
  SPLIT_KEYBOARD = yes
#+end_src

